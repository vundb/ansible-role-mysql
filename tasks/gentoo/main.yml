---

# rebuild required packages

- import_tasks: ../../../vundb-portage/tasks/gentoo/main.yml
  vars:
    portage_configuration: []
    portage_packages:
      - { package: "sys-libs/zlib", state: "unmerged" }
      - { package: "sys-libs/zlib", state: "emerged"  }


# install mysql

- name: install mysql server
  become: yes
  portage: package="dev-db/mysql" state=emerged newuse=yes update=yes
  register: mysql_install_state

- name: install python mysqldb module
  become: yes
  portage: package="dev-python/mysql-python" state=emerged newuse=yes update=yes


# configure mysql

- name: set root user password
  become: yes
  ini_file:
    dest: "/root/.my.cnf"
    section: "client"
    option: "password"
    value: "{{ mysql_root_password }}"
    create: yes

- name: check for mysql version
  shell: "emerge -pv dev-db/mysql | grep 'dev-db/mysql' | awk '{print $4}'"
  register: mysql_install_version
  when: mysql_install_state.changed

# TODO: run this command only when mysql database file not exists
- name: configure mysql instance (run only once after installation)
  become: yes
  command: "emerge --config ={{ mysql_install_version.stdout }}"
  when: mysql_install_state.changed

- name: delete log-bin config entry
  become: yes
  lineinfile: dest=/etc/mysql/my.cnf state=absent regexp="^log-bin"
  when: mysql_install_state.changed


# start mysql service

- name: ensure mysql is running
  become: yes
  service: name="mysql" state="started" enabled=yes
